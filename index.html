<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D Barangay eBlotter System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js for 4D Background Effect -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load Firebase libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let unsubscribeBlotters = null;
        let currentUserId = null;

        // Make Firebase objects globally accessible for the main script
        window.firebaseApp = {};

        // Helper for error messages
        window.showError = (message) => {
            document.getElementById('toast-message').textContent = message;
            document.getElementById('error-toast').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('error-toast').classList.add('hidden');
            }, 5000);
        };

        // Initialize Firebase and Authentication
        const initFirebase = async () => {
            try {
                // setLogLevel('debug'); // Uncomment for verbose Firestore logging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Expose to global scope for use in non-module script
                window.firebaseApp.db = db;

                // Sign in using the custom token or anonymously if not available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        window.firebaseApp.userId = currentUserId;
                        document.getElementById('user-id-display').textContent = `User ID: ${currentUserId}`;
                        document.getElementById('main-app').classList.remove('opacity-0');
                        
                        // Start real-time data listener only after auth is ready
                        window.startBlotterListener(db, appId, currentUserId);
                    } else {
                        showError("Authentication failed. Please check connection.");
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                showError("Failed to initialize system: " + error.message);
            }
        };

        // Expose Firebase Firestore functions to the global scope
        window.firebaseApp.firestore = {
            doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp
        };

        // This function will be called from the main script to start listening to data
        window.startBlotterListener = (dbInstance, appId, userId) => {
            if (unsubscribeBlotters) {
                unsubscribeBlotters();
            }

            // Public Data Path: /artifacts/{appId}/public/data/blotterRecords
            const blotterCollectionRef = collection(dbInstance, 'artifacts', appId, 'public', 'data', 'blotterRecords');
            
            // Set up real-time listener
            const q = query(blotterCollectionRef);

            unsubscribeBlotters = onSnapshot(q, (snapshot) => {
                const blotters = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Call the main JS function to update the UI
                window.handleBlotterUpdate(blotters, userId);
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                showError("Real-time data error: " + error.message);
            });
        };

        initFirebase();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d111c; /* Dark blue background */
            color: #e5e7eb;
            overflow: hidden; /* Hide scrollbar for immersive background */
        }
        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.2; /* Subtly dim the 3D effect */
        }
        .app-content {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            padding: 2rem;
            overflow-y: auto; /* Allow scrolling within the content area */
        }
        /* Custom scrollbar for better visual integration */
        .app-content::-webkit-scrollbar {
            width: 8px;
        }
        .app-content::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 4px;
        }
        .app-content::-webkit-scrollbar-track {
            background: #1f2937;
        }
    </style>
</head>
<body>

    <!-- Three.js 4D Background Container -->
    <div id="three-container"></div>

    <!-- Main Application Content -->
    <div id="main-app" class="app-content transition-opacity duration-500 opacity-0">
        <header class="text-center mb-10 p-4 rounded-xl bg-gray-800/80 backdrop-blur-sm shadow-2xl">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                Barangay eBlotter System
            </h1>
            <p class="text-sm text-gray-400 mt-2">Responsive & Real-time Case Management Interface</p>
        </header>

        <!-- User Role Switcher -->
        <div class="mb-8 p-4 bg-gray-800/70 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex-grow">
                <label for="role-select" class="block text-sm font-medium text-indigo-300 mb-1">Select User Role:</label>
                <select id="role-select" onchange="switchRole(this.value)" class="w-full md:w-64 p-2 bg-gray-900 border border-indigo-500 rounded-lg text-white shadow-inner focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="Citizen">Complainant/Citizen</option>
                    <option value="Staff">Barangay Staff/Secretary</option>
                    <option value="Admin">System Administrator</option>
                    <option value="Captain">Barangay Captain/Lupon</option>
                </select>
            </div>
            <div id="user-id-display" class="text-xs text-gray-400 bg-gray-900 p-2 rounded-lg truncate">User ID: N/A</div>
        </div>
        
        <!-- Main Content Area (Role-based views injected here) -->
        <div id="dashboard-container" class="space-y-6">
            <!-- Initial content will be loaded by switchRole() -->
        </div>

        <!-- Custom Modal for Notifications/Confirmations (No alert() or confirm()) -->
        <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full border border-indigo-600">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-400 mb-4">Modal Title</h3>
                <p id="modal-body" class="text-gray-300 mb-6">Modal body content.</p>
                <div class="flex justify-end gap-3">
                    <button id="modal-cancel-btn" onclick="closeModal(false)" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition duration-150 hidden">Cancel</button>
                    <button id="modal-confirm-btn" onclick="closeModal(true)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 transition duration-150">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Custom Error Toast -->
        <div id="error-toast" class="fixed bottom-4 right-4 hidden bg-red-800 text-white p-4 rounded-lg shadow-2xl z-50 transition duration-300" role="alert">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span id="toast-message" class="font-medium">An error occurred.</span>
            </div>
        </div>

    </div>

    <script>
        // ====================================================================
        // THREE.JS IMPLEMENTATION (4D BACKGROUND)
        // ====================================================================

        let scene, camera, renderer, particles, particleSystem;

        function initThree() {
            const container = document.getElementById('three-container');
            
            // Scene Setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer Setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            
            // Particle Geometry
            const particleCount = 1000;
            particles = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const color = new THREE.Color();
            
            // Create random particles in a box space
            for (let i = 0; i < particleCount; i++) {
                // Position (x, y, z)
                positions[i * 3 + 0] = (Math.random() - 0.5) * 50;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 50;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 50;
                
                // Color (subtle purple/indigo gradient)
                color.setHSL(0.6 + Math.random() * 0.1, 0.7, 0.5); 
                colors[i * 3 + 0] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }

            particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            // Particle Material
            const particleMaterial = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.8
            });

            // Particle System
            particleSystem = new THREE.Points(particles, particleMaterial);
            scene.add(particleSystem);

            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Subtle animation for the "4D" effect
            particleSystem.rotation.y += 0.0005;
            particleSystem.rotation.x += 0.0001;

            const positions = particleSystem.geometry.attributes.position.array;
            
            // Move particles slightly towards the center and then re-randomize
            for (let i = 0; i < positions.length / 3; i++) {
                positions[i * 3] += Math.sin(Date.now() * 0.0001 + i * 1) * 0.0001;
                positions[i * 3 + 1] += Math.cos(Date.now() * 0.0001 + i * 1) * 0.0001;
                positions[i * 3 + 2] += Math.sin(Date.now() * 0.0001 + i * 1) * 0.0001;
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;


            renderer.render(scene, camera);
        }

        // Start the 3D background on window load
        window.onload = function () {
            initThree();
            animate();
        };

        // ====================================================================
        // FIREBASE & APPLICATION LOGIC
        // ====================================================================

        let allBlotters = [];
        let currentRole = 'Citizen';
        let blotterToUpdateId = null;
        let blotterActionCallback = null;

        // Global function to receive real-time updates from Firestore listener
        window.handleBlotterUpdate = (blotters, userId) => {
            allBlotters = blotters;
            // Re-render the dashboard whenever data changes
            renderDashboard(currentRole, userId); 
        };

        // --- Utility Functions ---

        // Custom Modal (replaces alert/confirm)
        const showModal = (title, body, isConfirm, callback) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = body;
            
            const modal = document.getElementById('custom-modal');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            if (isConfirm) {
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = 'Proceed';
                blotterActionCallback = callback;
            } else {
                cancelBtn.classList.add('hidden');
                confirmBtn.textContent = 'OK';
                blotterActionCallback = null; // No action needed for simple alerts
            }

            modal.style.display = 'flex';
        };

        window.closeModal = (confirmed) => {
            document.getElementById('custom-modal').style.display = 'hidden';
            if (confirmed && blotterActionCallback) {
                blotterActionCallback();
            }
            // Reset for safety
            blotterActionCallback = null;
        };

        const generateBlotterId = () => {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 5);
            return (timestamp + random).toUpperCase();
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Firestore serverTimestamp is an object until saved, then a Timestamp
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        };

        // --- Core Firestore Operations ---

        const updateBlotterStatus = async (blotterId, newStatus, scheduledDate = null, remarks = '') => {
            const { db, userId, firestore } = window.firebaseApp;
            if (!db || !userId) return showError("System not initialized or user not logged in.");

            const { doc, updateDoc, collection } = firestore;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const blotterRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'blotterRecords'), blotterId);
            
            try {
                const updateData = {
                    status: newStatus,
                    remarks: remarks,
                    lastUpdatedBy: userId,
                    lastUpdated: firestore.serverTimestamp()
                };

                if (scheduledDate) {
                    updateData.mediationDate = scheduledDate;
                }

                await updateDoc(blotterRef, updateData);
                showModal('Success', `Case **${blotterId}** status updated to **${newStatus}**.`, false);

            } catch (error) {
                console.error("Error updating document:", error);
                showError("Failed to update case status: " + error.message);
            }
        };

        // --- Role-Based Dashboard Rendering ---

        const switchRole = (role) => {
            currentRole = role;
            const userId = window.firebaseApp.userId;
            renderDashboard(role, userId);
        };

        const renderDashboard = (role, userId) => {
            const container = document.getElementById('dashboard-container');
            let contentHTML = '';

            switch (role) {
                case 'Citizen':
                    contentHTML = renderCitizenView(userId);
                    break;
                case 'Staff':
                    contentHTML = renderStaffView(userId);
                    break;
                case 'Admin':
                    contentHTML = renderAdminView(userId);
                    break;
                case 'Captain':
                    contentHTML = renderCaptainView(userId);
                    break;
            }

            container.innerHTML = contentHTML;
            
            // Re-attach event listeners after innerHTML is set (for Staff/Captain views)
            if (role === 'Staff' || role === 'Captain') {
                attachModalEventListeners();
            }
            if (role === 'Citizen') {
                attachCitizenFormListener();
            }
        };

        // --- Citizen View ---

        const renderCitizenView = (userId) => {
            const citizenBlotters = allBlotters.filter(b => b.reporterId === userId);

            const listItems = citizenBlotters.length > 0
                ? citizenBlotters.map(b => `
                    <li class="p-4 bg-gray-700/70 rounded-lg shadow-md border-l-4 border-indigo-400 flex justify-between items-center flex-wrap">
                        <div>
                            <p class="font-bold text-indigo-300">Case ID: ${b.id}</p>
                            <p class="text-sm text-gray-400">Incident: ${b.incidentType}</p>
                            <p class="text-sm text-gray-400">Details: ${b.details.substring(0, 50)}...</p>
                        </div>
                        <div class="text-right mt-2 md:mt-0">
                            <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(b.status)}">
                                ${b.status}
                            </span>
                            <p class="text-xs text-gray-500 mt-1">Filed: ${formatDate(b.timestamp)}</p>
                        </div>
                    </li>
                `).join('')
                : '<p class="text-center text-gray-400 p-4 bg-gray-800/70 rounded-lg">No blotter records found for your user ID.</p>';


            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Submit Online Blotter/Complaint -->
                    <div class="lg:col-span-1 p-6 bg-gray-800/70 rounded-xl shadow-2xl border border-indigo-700 h-fit">
                        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">Submit New Complaint</h2>
                        <form id="blotter-form" class="space-y-4">
                            <div>
                                <label for="incidentType" class="block text-sm font-medium text-gray-400">Incident Type</label>
                                <select id="incidentType" required class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-indigo-500">
                                    <option value="">Select Type</option>
                                    <option value="Physical Dispute">Physical Dispute</option>
                                    <option value="Theft/Robbery">Theft/Robbery</option>
                                    <option value="Property Damage">Property Damage</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="details" class="block text-sm font-medium text-gray-400">Details of Incident</label>
                                <textarea id="details" rows="4" required class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-indigo-500" placeholder="Provide a brief description..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-200 shadow-md">
                                Submit Blotter
                            </button>
                        </form>
                    </div>

                    <!-- Track Case Status -->
                    <div class="lg:col-span-2 p-6 bg-gray-800/70 rounded-xl shadow-2xl border border-gray-700">
                        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">Your Case Status</h2>
                        <ul class="space-y-3">
                            ${listItems}
                        </ul>
                    </div>
                </div>
            `;
        };
        
        const attachCitizenFormListener = () => {
            const form = document.getElementById('blotter-form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const { db, userId, firestore } = window.firebaseApp;
                    if (!db || !userId) return showError("System not initialized or user not logged in.");

                    const incidentType = document.getElementById('incidentType').value;
                    const details = document.getElementById('details').value;
                    
                    if (!incidentType || !details) return showError("Please fill out all fields.");

                    const newBlotter = {
                        blotterId: generateBlotterId(), // Using custom ID generator for presentation
                        reporterId: userId,
                        incidentType: incidentType,
                        details: details,
                        status: 'Filed',
                        timestamp: firestore.serverTimestamp(),
                        lastUpdated: firestore.serverTimestamp()
                    };

                    try {
                        const { addDoc, collection } = firestore;
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const blotterCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'blotterRecords');
                        
                        await addDoc(blotterCollectionRef, newBlotter);
                        
                        showModal('Success!', `Your complaint has been successfully filed with Case ID: **${newBlotter.blotterId}**. You can track its status below.`, false);
                        form.reset(); // Clear the form
                    } catch (error) {
                        console.error("Error submitting blotter:", error);
                        showError("Failed to submit blotter: " + error.message);
                    }
                });
            }
        };

        // --- Staff View ---

        const renderStaffView = (userId) => {
            // Include: Update Case Status/Details, Schedule Conciliation/Mediation, Record New Incident Data, Search & View Blotter Records
            const openCases = allBlotters.filter(b => b.status !== 'Closed' && b.status !== 'Approved');

            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-indigo-300">Staff Dashboard</h2>

                    <!-- Record New Incident Data (Mocked) -->
                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-400">Record New Incident Data</h3>
                        <p class="text-gray-400">
                            Use a separate form to record incidents not yet reported by a citizen. This functionality is part of the "Record New Incident Data" use case. (Mocked: Use the Citizen form to simulate this.)
                        </p>
                    </div>

                    <!-- Search & View Blotter Records (Table) -->
                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-indigo-700">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-400">Open Cases for Action (${openCases.length})</h3>
                        ${renderBlotterTable(openCases, 'Staff')}
                    </div>
                </div>
            `;
        };

        // --- Admin View ---

        const renderAdminView = (userId) => {
            // Include: Generate Statistical Reports (incl. AI Insights), Search & View Blotter Records, Manage User Accounts & Roles
            const closedCases = allBlotters.filter(b => b.status === 'Closed' || b.status === 'Approved').length;
            const openCases = allBlotters.filter(b => b.status !== 'Closed' && b.status !== 'Approved').length;
            const totalCases = allBlotters.length;
            const mediationScheduled = allBlotters.filter(b => b.status === 'Scheduled').length;

            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-indigo-300">System Administrator Dashboard</h2>

                    <!-- Statistical Reports (Mocked AI Insights) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        ${renderStatCard('Total Cases', totalCases, 'bg-purple-600', 'fas fa-chart-line')}
                        ${renderStatCard('Open Cases', openCases, 'bg-blue-600', 'fas fa-clock')}
                        ${renderStatCard('Closed Cases', closedCases, 'bg-green-600', 'fas fa-check-circle')}
                        ${renderStatCard('Mediation Scheduled', mediationScheduled, 'bg-yellow-600', 'fas fa-calendar')}
                    </div>

                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-indigo-700">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-400">AI Insights & Trends (Mocked)</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300 ml-4">
                            <li><span class="font-bold text-red-400">High Risk:</span> Theft/Robbery incidents rose by 15% in the last quarter (Predicted hotspot: Zone 5).</li>
                            <li><span class="font-bold text-green-400">Efficiency:</span> Average case resolution time reduced by 5 days due to new scheduling process.</li>
                            <li><span class="font-bold text-blue-400">System Load:</span> 85% of citizens use the Chatbot Interface (Submit/Track).</li>
                        </ul>
                    </div>

                    <!-- Search & View Blotter Records (Table) -->
                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-400">Full Blotter Records</h3>
                        ${renderBlotterTable(allBlotters, 'Admin')}
                    </div>

                    <!-- Manage User Accounts & Roles (Mocked) -->
                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-400">Manage User Accounts & Roles (Mocked)</h3>
                        <p class="text-gray-400">
                            Interface for managing Barangay Staff, Captains, and Admin accounts would be implemented here, allowing for role assignment and account deactivation.
                        </p>
                    </div>
                </div>
            `;
        };

        const renderStatCard = (title, value, color, iconClass) => `
            <div class="p-4 ${color} rounded-xl shadow-xl flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-white/80">${title}</p>
                    <p class="text-3xl font-bold text-white">${value}</p>
                </div>
                <!-- Mock Icon -->
                <svg class="w-8 h-8 text-white/70" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            </div>
        `;

        // --- Captain View ---

        const renderCaptainView = (userId) => {
            // Include: Review & Approve Case Decisions
            const casesPendingApproval = allBlotters.filter(b => b.status === 'Decision Ready');

            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-indigo-300">Barangay Captain / Lupon Dashboard</h2>
                    
                    <!-- Review & Approve Case Decisions -->
                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-indigo-700">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-400">Cases Pending Final Decision (${casesPendingApproval.length})</h3>
                        ${renderBlotterTable(casesPendingApproval, 'Captain')}
                    </div>

                    <!-- Other Duties Mock -->
                    <div class="p-6 bg-gray-800/70 rounded-xl shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-400">Other Lupon/Captain Tasks (Mocked)</h3>
                        <p class="text-gray-400">
                            The Captain/Lupon also reviews statistical reports and operational insights to make policy decisions based on the data provided by the Administrator.
                        </p>
                    </div>
                </div>
            `;
        };

        // --- Shared Table Renderer ---

        const getStatusColor = (status) => {
            switch (status) {
                case 'Filed': return 'bg-blue-600 text-white';
                case 'Scheduled': return 'bg-yellow-600 text-gray-900';
                case 'Review':
                case 'Decision Ready': return 'bg-red-600 text-white';
                case 'Closed': return 'bg-green-600 text-white';
                case 'Approved': return 'bg-indigo-600 text-white';
                default: return 'bg-gray-500 text-white';
            }
        };

        const renderBlotterTable = (blotters, viewerRole) => {
            if (blotters.length === 0) {
                return '<p class="text-center text-gray-400 p-4">No records to display for this view.</p>';
            }

            // Sort by status (Pending/Review first)
            blotters.sort((a, b) => {
                if (a.status === 'Decision Ready' && b.status !== 'Decision Ready') return -1;
                if (a.status !== 'Decision Ready' && b.status === 'Decision Ready') return 1;
                return b.timestamp?.toMillis() - a.timestamp?.toMillis(); // Latest first
            });

            const rows = blotters.map(b => {
                let actionButton = '';
                if (viewerRole === 'Staff' && b.status !== 'Decision Ready' && b.status !== 'Approved' && b.status !== 'Closed') {
                    actionButton = `<button data-id="${b.id}" data-type="staff-update" class="text-sm font-medium text-indigo-400 hover:text-indigo-200 transition duration-150">Update/Schedule</button>`;
                } else if (viewerRole === 'Captain' && b.status === 'Decision Ready') {
                    actionButton = `
                        <button data-id="${b.id}" data-type="captain-approve" class="text-sm font-medium text-green-400 hover:text-green-200 mr-2 transition duration-150">Approve</button>
                        <button data-id="${b.id}" data-type="captain-reject" class="text-sm font-medium text-red-400 hover:text-red-200 transition duration-150">Reject</button>
                    `;
                } else if (viewerRole === 'Admin') {
                    // Admin only views, no direct actions here
                    actionButton = `<span class="text-gray-500 text-xs">View Only</span>`;
                }

                return `
                    <tr class="hover:bg-gray-700/80 transition duration-150 border-t border-gray-700">
                        <td class="p-3 text-sm font-medium text-indigo-300">${b.blotterId || b.id.substring(0, 8)}...</td>
                        <td class="p-3 text-sm">${b.incidentType}</td>
                        <td class="p-3 text-sm text-gray-400 truncate max-w-xs">${b.details.substring(0, 100)}...</td>
                        <td class="p-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(b.status)}">
                                ${b.status}
                            </span>
                        </td>
                        <td class="p-3 text-sm text-gray-500">${b.mediationDate || 'N/A'}</td>
                        <td class="p-3 whitespace-nowrap">${actionButton}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="overflow-x-auto rounded-lg shadow-inner">
                    <table class="min-w-full divide-y divide-gray-700 bg-gray-900/90">
                        <thead class="bg-gray-700/90">
                            <tr>
                                <th class="p-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Case ID</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Details</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Schedule</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="blotter-table-body" class="divide-y divide-gray-800">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        // --- Event Listeners for Dynamic Actions ---

        const attachModalEventListeners = () => {
            document.querySelectorAll('[data-type="staff-update"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    showStaffUpdateModal(id);
                });
            });

            document.querySelectorAll('[data-type="captain-approve"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    showCaptainDecisionModal(id, 'Approve');
                });
            });

            document.querySelectorAll('[data-type="captain-reject"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    showCaptainDecisionModal(id, 'Close'); // Rejecting closes the case
                });
            });
        };

        const showStaffUpdateModal = (blotterId) => {
            blotterToUpdateId = blotterId;
            const blotter = allBlotters.find(b => b.id === blotterId);

            const modalBody = `
                <p class="mb-4 text-gray-400">Update status for Case ID: <strong>${blotter.blotterId || blotter.id}</strong></p>
                <div class="space-y-3">
                    <div>
                        <label for="modal-status" class="block text-sm font-medium text-gray-300">New Status</label>
                        <select id="modal-status" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="Filed">Filed</option>
                            <option value="Review">Under Review</option>
                            <option value="Scheduled">Scheduled Conciliation/Mediation</option>
                            <option value="Decision Ready">Ready for Captain Review</option>
                            <option value="Closed">Closed (Resolved/Withdrawn)</option>
                        </select>
                    </div>
                    <div>
                        <label for="modal-date" class="block text-sm font-medium text-gray-300">Mediation/Conciliation Date (Optional)</label>
                        <input type="datetime-local" id="modal-date" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    </div>
                    <div>
                        <label for="modal-remarks" class="block text-sm font-medium text-gray-300">Staff Remarks</label>
                        <textarea id="modal-remarks" rows="2" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Add notes on the update..."></textarea>
                    </div>
                </div>
            `;
            
            showModal('Update Case Details', modalBody, true, () => {
                const newStatus = document.getElementById('modal-status').value;
                const date = document.getElementById('modal-date').value;
                const remarks = document.getElementById('modal-remarks').value;
                
                updateBlotterStatus(blotterToUpdateId, newStatus, date, remarks);
                blotterToUpdateId = null; // Clear ID after use
            });
        };

        const showCaptainDecisionModal = (blotterId, action) => {
            blotterToUpdateId = blotterId;
            const blotter = allBlotters.find(b => b.id === blotterId);
            const statusText = action === 'Approve' ? 'APPROVAL' : 'REJECTION (Case Closure)';

            const modalBody = `
                <p class="mb-4 text-gray-400">Confirm **${statusText}** for Case ID: <strong>${blotter.blotterId || blotter.id}</strong></p>
                <p class="mb-4 text-sm text-red-300">This action is final and will set the case status to **${action}**.</p>
                <div>
                    <label for="captain-remarks" class="block text-sm font-medium text-gray-300">Captain's Decision Notes</label>
                    <textarea id="captain-remarks" rows="2" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Reason for decision..."></textarea>
                </div>
            `;
            
            showModal(`Final Decision: ${action}`, modalBody, true, () => {
                const remarks = document.getElementById('captain-remarks').value;
                
                updateBlotterStatus(blotterToUpdateId, action, null, remarks);
                blotterToUpdateId = null; // Clear ID after use
            });
        };

        // Initialize view on load
        document.addEventListener('DOMContentLoaded', () => {
            // This ensures the initial view is rendered once Firebase Auth is ready
            // The actual render is triggered by the onAuthStateChanged in the module script
            // For now, set the default selection
            document.getElementById('role-select').value = 'Citizen'; 
        });

    </script>
</body>
</html>
